version: '3'

vars:
  REQUIRED_TOOLS_LIST: kubectl, flux

tasks:

  default:
  - task: :helpers:validate
    vars:
      REQUIRED_TOOLS_LIST: "{{.REQUIRED_TOOLS_LIST}}"

  verify:
    deps: [default]
    desc: Verify flux meets the prerequisites
    cmds:
    - flux check --pre

  bootstrap:
    silent: false
    desc: Executes FluxCD Bootstrap against Target K8s Cluster
    deps: [verify]
    precondition:
    - test -d {{.PROJECT_DIR}}/clusters/{{.K8S_CLUSTER_NAME}}/platform
    cmds:
    - task: git-promote
    - kubectl create ns flux-system --dry-run=client -o yaml | kubectl apply -f -
    - task: create-decrypt-secret
    - |
      export GITHUB_TOKEN={{.GITHUB_TOKEN}} && \
      flux bootstrap github \
        --owner={{.GITHUB_USER}} \
        --repository={{.GITHUB_REPO}} \
        --branch={{.GITHUB_BRANCH}} \
        --personal \
        --path=clusters/{{.K8S_CLUSTER_NAME}} \
        --reconcile \
        --force
    requires:
      vars: [K8S_CLUSTER_NAME, GITHUB_USER, GITHUB_REPO, GITHUB_BRANCH]

  git-promote:
    desc: Adds newly created cluster to git and pushes to remote branch
    precondition:
    - test -d {{.PROJECT_DIR}}/clusters/{{.K8S_CLUSTER_NAME}}/platform
    prompt: "This will commit the code locally, push remotely and bootstrap the following cluster: {{.K8S_CLUSTER_NAME}}. Do you wish to continue?"
    cmds:
    - 'git add clusters/{{.K8S_CLUSTER_NAME}}'
    - 'git commit -am "add: cluster-configs for new cluster {{.K8S_CLUSTER_NAME}}"'
    - 'git pull origin --autostash'
    - 'git push origin'
    requires:
      vars: [K8S_CLUSTER_NAME, GITHUB_BRANCH]

  create-decrypt-secret:
    desc: Create K8s secret with SOPS age key
    cmds:
    - |
      cat {{.SOPS_AGE_KEY_FILE}} |
      kubectl create secret generic sops-age \
        --namespace=flux-system \
        --from-file=age.agekey=/dev/stdin \
        --dry-run=client -o yaml | kubectl apply -f -
    preconditions:
    - sh: test -f {{.SOPS_AGE_KEY_FILE}}
      msg: |
        Age Key not found. Have you initialized local configs?
    requires:
      vars: [SOPS_AGE_KEY_FILE]

  reconcile:
    desc: Force update Flux to pull in changes from your Git repository
    cmds:
    - flux reconcile -n flux-system source git flux-system
    - flux reconcile -n flux-system kustomization flux-system

  tshoot:
    desc: Use to troubleshoot issues with flux resources
    cmds:
    - flux get all
    - flux stats

  # install:
  #   desc: Install Flux into your cluster
  #   cmds:
  #     - kubectl apply --kustomize {{.CLUSTER_DIR}}/bootstrap/
  #     - cat {{.SOPS_AGE_KEY_FILE}} | kubectl -n flux-system create secret generic sops-age --from-file=age.agekey=/dev/stdin
  #     - kubectl apply --kustomize {{.CLUSTER_DIR}}/flux/flux-system/
  #     - task: reconcile
  #   preconditions:
  #     - sh: test -f {{.SOPS_AGE_KEY_FILE}}
  #       msg: |
  #         Age key file is not found. Did you forget to create it?
  #   vars:
  #     SOPS_AGE_KEY_FILE: ~/.config/sops/age/keys.txt
