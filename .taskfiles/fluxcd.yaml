version: '3'

vars:
  REQUIRED_TOOLS_LIST: kubectl, flux

tasks:

  default:
  - task: :helpers:validate
    vars:
      REQUIRED_TOOLS_LIST: "{{.REQUIRED_TOOLS_LIST}}"

  check:
    deps: [default]
    cmds:
    - flux check --pre

  bootstrap:
    silent: true
    desc: Executes FluxCD Bootstrap against Target K8s Cluster
    deps: [check]
    vars:
      K8S_CLUSTER_NAME:
        sh: kubectl config view --minify -o jsonpath='{.clusters[].name}'
    precondition:
    - test -d {{.PROJECT_DIR}}/clusters/{{.K8S_CLUSTER_NAME}}/platform
    prompt: "This will commit the code locally, push remotely and bootstrap the following cluster: {{.K8S_CLUSTER_NAME}}. Do you wish to continue?"
    cmds:
    - 'git add clusters/{{.K8S_CLUSTER_NAME}}'
    - 'git commit -am "add: cluster-configs for new cluster nke-gitops-workload-00"'
    - 'git push origin'
    - |
      flux bootstrap github \
        --owner=${GITHUB_USER} \
        --repository=${GITHUB_REPO} \
        --branch=main \
        --personal \
        --path=clusters/{{.K8S_CLUSTER_NAME}} \
        --force
    requires:
      vars: [GITHUB_USER, GITHUB_REPO]
