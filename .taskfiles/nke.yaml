version: '3'

vars:
  REQUIRED_TOOLS_LIST: kubectl,kubectl-karbon
  K8S_DISTRO_NAME: 'Nutanix Kubernetes Engine (NKE)'

tasks:

  default:
  - task: :helpers:validate
    vars:
      REQUIRED_TOOLS_LIST: "{{.REQUIRED_TOOLS_LIST}}"

  download-creds:
    deps: [default]
    silent: false
    desc: Download NKE kubeconfig for specific cluster
    cmds:
    - 'KARBON_PASSWORD="{{.PRISM_CENTRAL_PASS}}" kubectl karbon login -u {{.PRISM_CENTRAL_USER}} --server {{.PRISM_CENTRAL_ENDPOINT}} --cluster {{.K8S_CLUSTER_NAME}} --kubeconfig ${HOME}/.kube/{{.K8S_CLUSTER_NAME}}.cfg --force --insecure'
    - 'export KUBECONFIG=$KUBECONFIG:${HOME}/.kube/{{.K8S_CLUSTER_NAME}}.cfg'
    requires:
      vars: [K8S_CLUSTER_NAME, PRISM_CENTRAL_PASS, PRISM_CENTRAL_USER, PRISM_CENTRAL_ENDPOINT]

  select-creds:
    deps: [default]
    silent: false
    desc: Download NKE kubeconfig for any cluster available on PC.
    vars:
      PRISM_CENTRAL_ENDPOINT:
        sh: 'task bootstrap:gum -- input --header "What is your Prism Central Endpoint" --placeholder {{.PRISM_CENTRAL_ENDPOINT}} --value {{.PRISM_CENTRAL_ENDPOINT}}'
      PRISM_CENTRAL_USER:
        sh: 'task bootstrap:gum -- input --header "What is your Prism Central Username" --placeholder {{.PRISM_CENTRAL_USER}} --value {{.PRISM_CENTRAL_USER}}'
      PRISM_CENTRAL_PASS:
        sh: 'task bootstrap:gum -- input --header "What is your Prism Central Password" --placeholder {{.PRISM_CENTRAL_PASS}} --value {{.PRISM_CENTRAL_PASS}} --password'
    cmds:
    - 'KARBON_PASSWORD="{{.PRISM_CENTRAL_PASS}}" kubectl karbon login -u {{.PRISM_CENTRAL_USER}} --server {{.PRISM_CENTRAL_ENDPOINT}} --force --insecure'
